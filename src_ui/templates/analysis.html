<!DOCTYPE html>
<html lang="zh">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>数据分析 - 船舶调度系统</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>

<body>
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <div class="container-fluid">
                        <a class="navbar-brand" href="/">船舶调度系统</a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                data-bs-target="#navbarNav" aria-label="切换导航">
                                <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarNav">
                                <ul class="navbar-nav">
                                        <li class="nav-item">
                                                <a class="nav-link" href="/overview">概览</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link" href="/data">数据管理</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link" href="/optimization">调度优化</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link active" href="/analysis">数据分析</a>
                                        </li>
                                </ul>
                        </div>
                </div>
        </nav>

        <div class="container-fluid mt-4">
                <!-- 分析类型选择 -->
                <div class="row mb-4">
                        <div class="col-12">
                                <div class="card">
                                        <div class="card-body">
                                                <div class="row">
                                                        <div class="col-md-4">
                                                                <label for="analysisType"
                                                                        class="form-label">分析类型</label>
                                                                <select class="form-select" id="analysisType"
                                                                        aria-label="选择分析类型" title="选择分析类型"
                                                                        onchange="updateAnalysis()">
                                                                        <option value="performance">性能分析</option>
                                                                        <option value="efficiency">效率分析</option>
                                                                        <option value="cost">成本分析</option>
                                                                        <option value="emissions">碳排放分析</option>
                                                                </select>
                                                        </div>
                                                        <div class="col-md-4">
                                                                <label for="timeRange" class="form-label">时间范围</label>
                                                                <select class="form-select" id="timeRange"
                                                                        aria-label="选择时间范围" title="选择时间范围"
                                                                        onchange="updateAnalysis()">
                                                                        <option value="day">日</option>
                                                                        <option value="week">周</option>
                                                                        <option value="month">月</option>
                                                                        <option value="year">年</option>
                                                                </select>
                                                        </div>
                                                        <div class="col-md-4">
                                                                <label for="dataSource" class="form-label">数据来源</label>
                                                                <select class="form-select" id="dataSource"
                                                                        aria-label="选择数据来源" title="选择数据来源"
                                                                        onchange="updateAnalysis()">
                                                                        <option value="all">全部</option>
                                                                        <option value="ships">船舶</option>
                                                                        <option value="routes">航线</option>
                                                                        <option value="ports">港口</option>
                                                                </select>
                                                        </div>
                                                </div>
                                        </div>
                                </div>
                        </div>
                </div>

                <!-- 图表展示区域 -->
                <div class="row">
                        <!-- 主要指标 -->
                        <div class="col-md-3">
                                <div class="card mb-4">
                                        <div class="card-body">
                                                <h6 class="card-title">平均响应时间</h6>
                                                <h3 class="card-text" id="avgResponseTime">-</h3>
                                        </div>
                                </div>
                                <div class="card mb-4">
                                        <div class="card-body">
                                                <h6 class="card-title">资源利用率</h6>
                                                <h3 class="card-text" id="resourceUtilization">-</h3>
                                        </div>
                                </div>
                                <div class="card mb-4">
                                        <div class="card-body">
                                                <h6 class="card-title">成本效益比</h6>
                                                <h3 class="card-text" id="costEfficiency">-</h3>
                                        </div>
                                </div>
                                <div class="card">
                                        <div class="card-body">
                                                <h6 class="card-title">碳排放强度</h6>
                                                <h3 class="card-text" id="emissionIntensity">-</h3>
                                        </div>
                                </div>
                        </div>

                        <!-- 趋势图 -->
                        <div class="col-md-9">
                                <div class="card mb-4">
                                        <div class="card-header">
                                                <h5 class="card-title mb-0">趋势分析</h5>
                                        </div>
                                        <div class="card-body">
                                                <div id="trendChart" style="height: 400px;"></div>
                                        </div>
                                </div>
                        </div>
                </div>

                <!-- 详细分析 -->
                <div class="row">
                        <!-- 分布图 -->
                        <div class="col-md-6">
                                <div class="card mb-4">
                                        <div class="card-header">
                                                <h5 class="card-title mb-0">分布分析</h5>
                                        </div>
                                        <div class="card-body">
                                                <div id="distributionChart" style="height: 400px;"></div>
                                        </div>
                                </div>
                        </div>

                        <!-- 对比图 -->
                        <div class="col-md-6">
                                <div class="card mb-4">
                                        <div class="card-header">
                                                <h5 class="card-title mb-0">对比分析</h5>
                                        </div>
                                        <div class="card-body">
                                                <div id="comparisonChart" style="height: 400px;"></div>
                                        </div>
                                </div>
                        </div>
                </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
                // 初始化图表
                function initCharts() {
                        // 趋势图
                        const trendChart = echarts.init(document.getElementById('trendChart'));
                        const trendOption = {
                                title: {
                                        text: '趋势分析'
                                },
                                tooltip: {
                                        trigger: 'axis'
                                },
                                legend: {
                                        data: ['指标1', '指标2', '指标3']
                                },
                                xAxis: {
                                        type: 'category',
                                        data: []
                                },
                                yAxis: {
                                        type: 'value'
                                },
                                series: [{
                                                name: '指标1',
                                                type: 'line',
                                                data: []
                                        },
                                        {
                                                name: '指标2',
                                                type: 'line',
                                                data: []
                                        },
                                        {
                                                name: '指标3',
                                                type: 'line',
                                                data: []
                                        }
                                ]
                        };
                        trendChart.setOption(trendOption);

                        // 分布图
                        const distributionChart = echarts.init(document.getElementById('distributionChart'));
                        const distributionOption = {
                                title: {
                                        text: '分布分析'
                                },
                                tooltip: {
                                        trigger: 'item'
                                },
                                legend: {
                                        orient: 'vertical',
                                        left: 'left'
                                },
                                series: [{
                                        type: 'pie',
                                        radius: '50%',
                                        data: [],
                                        emphasis: {
                                                itemStyle: {
                                                        shadowBlur: 10,
                                                        shadowOffsetX: 0,
                                                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                                                }
                                        }
                                }]
                        };
                        distributionChart.setOption(distributionOption);

                        // 对比图
                        const comparisonChart = echarts.init(document.getElementById('comparisonChart'));
                        const comparisonOption = {
                                title: {
                                        text: '对比分析'
                                },
                                tooltip: {
                                        trigger: 'axis',
                                        axisPointer: {
                                                type: 'shadow'
                                        }
                                },
                                legend: {
                                        data: ['实际值', '目标值']
                                },
                                xAxis: {
                                        type: 'category',
                                        data: []
                                },
                                yAxis: {
                                        type: 'value'
                                },
                                series: [{
                                                name: '实际值',
                                                type: 'bar',
                                                data: []
                                        },
                                        {
                                                name: '目标值',
                                                type: 'bar',
                                                data: []
                                        }
                                ]
                        };
                        comparisonChart.setOption(comparisonOption);

                        // 窗口大小改变时重绘图表
                        window.addEventListener('resize', function () {
                                trendChart.resize();
                                distributionChart.resize();
                                comparisonChart.resize();
                        });
                }

                // 更新分析
                async function updateAnalysis() {
                        const analysisType = document.getElementById('analysisType').value;
                        const timeRange = document.getElementById('timeRange').value;
                        const dataSource = document.getElementById('dataSource').value;

                        try {
                                // 获取分析数据
                                const response = await fetch(
                                        `/api/analysis?type=${analysisType}&range=${timeRange}&source=${dataSource}`
                                );
                                const data = await response.json();

                                // 更新主要指标
                                document.getElementById('avgResponseTime').textContent = data.metrics
                                        .avg_response_time;
                                document.getElementById('resourceUtilization').textContent = data.metrics
                                        .resource_utilization;
                                document.getElementById('costEfficiency').textContent = data.metrics
                                        .cost_efficiency;
                                document.getElementById('emissionIntensity').textContent = data.metrics
                                        .emission_intensity;

                                // 更新趋势图
                                const trendChart = echarts.getInstanceByDom(document.getElementById(
                                        'trendChart'));
                                trendChart.setOption({
                                        xAxis: {
                                                data: data.trend.dates
                                        },
                                        series: [{
                                                        name: '指标1',
                                                        data: data.trend.metric1
                                                },
                                                {
                                                        name: '指标2',
                                                        data: data.trend.metric2
                                                },
                                                {
                                                        name: '指标3',
                                                        data: data.trend.metric3
                                                }
                                        ]
                                });

                                // 更新分布图
                                const distributionChart = echarts.getInstanceByDom(document.getElementById(
                                        'distributionChart'));
                                distributionChart.setOption({
                                        series: [{
                                                data: data.distribution
                                        }]
                                });

                                // 更新对比图
                                const comparisonChart = echarts.getInstanceByDom(document.getElementById(
                                        'comparisonChart'));
                                comparisonChart.setOption({
                                        xAxis: {
                                                data: data.comparison.categories
                                        },
                                        series: [{
                                                        name: '实际值',
                                                        data: data.comparison.actual
                                                },
                                                {
                                                        name: '目标值',
                                                        data: data.comparison.target
                                                }
                                        ]
                                });

                        } catch (error) {
                                console.error('更新分析失败:', error);
                        }
                }

                // 页面加载完成后初始化
                document.addEventListener('DOMContentLoaded', () => {
                        initCharts();
                        updateAnalysis();
                });
        </script>
</body>

</html>