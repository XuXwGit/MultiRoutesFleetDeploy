<!DOCTYPE html>
<html lang="zh">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>调度优化 - 船舶调度系统</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>

<body>
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <div class="container-fluid">
                        <a class="navbar-brand" href="/">船舶调度系统</a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                data-bs-target="#navbarNav" aria-label="切换导航">
                                <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarNav">
                                <ul class="navbar-nav">
                                        <li class="nav-item">
                                                <a class="nav-link" href="/overview">概览</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link" href="/data">数据管理</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link active" href="/optimization">调度优化</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link" href="/analysis">数据分析</a>
                                        </li>
                                </ul>
                        </div>
                </div>
        </nav>

        <div class="container-fluid mt-4">
                <div class="row">
                        <!-- 左侧参数设置 -->
                        <div class="col-md-4">
                                <div class="card mb-4">
                                        <div class="card-header">
                                                <h5 class="card-title mb-0">模型参数设置</h5>
                                        </div>
                                        <div class="card-body">
                                                <form id="modelParamsForm">
                                                        <div class="mb-3">
                                                                <label for="timeWindow" class="form-label">时间窗口</label>
                                                                <input type="number" class="form-control"
                                                                        id="timeWindow" min="1" max="30" value="7">
                                                        </div>
                                                        <div class="mb-3">
                                                                <label for="maxIterations"
                                                                        class="form-label">最大迭代次数</label>
                                                                <input type="number" class="form-control"
                                                                        id="maxIterations" min="100" max="10000"
                                                                        value="1000">
                                                        </div>
                                                        <div class="mb-3">
                                                                <label for="populationSize"
                                                                        class="form-label">种群大小</label>
                                                                <input type="number" class="form-control"
                                                                        id="populationSize" min="10" max="500"
                                                                        value="100">
                                                        </div>
                                                        <div class="mb-3">
                                                                <label for="mutationRate" class="form-label">变异率</label>
                                                                <input type="number" class="form-control"
                                                                        id="mutationRate" min="0" max="1" step="0.1"
                                                                        value="0.1">
                                                        </div>
                                                </form>
                                        </div>
                                </div>

                                <div class="card">
                                        <div class="card-header">
                                                <h5 class="card-title mb-0">算法参数设置</h5>
                                        </div>
                                        <div class="card-body">
                                                <form id="algorithmParamsForm">
                                                        <div class="mb-3">
                                                                <label for="algorithm" class="form-label">优化算法</label>
                                                                <select class="form-select" id="algorithm"
                                                                        aria-label="选择优化算法" title="选择优化算法">
                                                                        <option value="genetic">遗传算法</option>
                                                                        <option value="ant">蚁群算法</option>
                                                                        <option value="dp">动态规划</option>
                                                                </select>
                                                        </div>
                                                        <div class="mb-3">
                                                                <label for="optimizationGoal"
                                                                        class="form-label">优化目标</label>
                                                                <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox"
                                                                                id="goal_time" checked>
                                                                        <label class="form-check-label"
                                                                                for="goal_time">时间</label>
                                                                </div>
                                                                <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox"
                                                                                id="goal_cost" checked>
                                                                        <label class="form-check-label"
                                                                                for="goal_cost">成本</label>
                                                                </div>
                                                                <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox"
                                                                                id="goal_emissions">
                                                                        <label class="form-check-label"
                                                                                for="goal_emissions">碳排放</label>
                                                                </div>
                                                        </div>
                                                        <div class="mb-3">
                                                                <label for="weightTime" class="form-label">时间权重</label>
                                                                <input type="range" class="form-range" id="weightTime"
                                                                        min="0" max="1" step="0.1" value="0.4">
                                                        </div>
                                                        <div class="mb-3">
                                                                <label for="weightCost" class="form-label">成本权重</label>
                                                                <input type="range" class="form-range" id="weightCost"
                                                                        min="0" max="1" step="0.1" value="0.4">
                                                        </div>
                                                        <div class="mb-3">
                                                                <label for="weightEmissions"
                                                                        class="form-label">碳排放权重</label>
                                                                <input type="range" class="form-range"
                                                                        id="weightEmissions" min="0" max="1" step="0.1"
                                                                        value="0.2">
                                                        </div>
                                                </form>
                                        </div>
                                </div>
                        </div>

                        <!-- 右侧优化结果 -->
                        <div class="col-md-8">
                                <div class="card mb-4">
                                        <div class="card-header">
                                                <h5 class="card-title mb-0">优化进度</h5>
                                        </div>
                                        <div class="card-body">
                                                <div class="progress mb-3">
                                                        <div class="progress-bar" role="progressbar" style="width: 0%"
                                                                id="optimizationProgress"></div>
                                                </div>
                                                <div id="optimizationLog" class="border p-3"
                                                        style="height: 200px; overflow-y: auto;">
                                                        <!-- 优化日志将在这里显示 -->
                                                </div>
                                        </div>
                                </div>

                                <div class="card">
                                        <div class="card-header">
                                                <h5 class="card-title mb-0">优化结果</h5>
                                        </div>
                                        <div class="card-body">
                                                <div class="row mb-4">
                                                        <div class="col-md-4">
                                                                <div class="card">
                                                                        <div class="card-body">
                                                                                <h6 class="card-title">总时间</h6>
                                                                                <h3 class="card-text" id="totalTime">-
                                                                                </h3>
                                                                        </div>
                                                                </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                                <div class="card">
                                                                        <div class="card-body">
                                                                                <h6 class="card-title">总成本</h6>
                                                                                <h3 class="card-text" id="totalCost">-
                                                                                </h3>
                                                                        </div>
                                                                </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                                <div class="card">
                                                                        <div class="card-body">
                                                                                <h6 class="card-title">碳排放</h6>
                                                                                <h3 class="card-text"
                                                                                        id="totalEmissions">-</h3>
                                                                        </div>
                                                                </div>
                                                        </div>
                                                </div>
                                                <div id="optimizationChart" style="height: 400px;"></div>
                                        </div>
                                </div>
                        </div>
                </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
        <script>
                // 初始化图表
                function initChart() {
                        const chart = echarts.init(document.getElementById('optimizationChart'));
                        const option = {
                                title: {
                                        text: '优化过程'
                                },
                                tooltip: {
                                        trigger: 'axis'
                                },
                                legend: {
                                        data: ['时间', '成本', '碳排放']
                                },
                                xAxis: {
                                        type: 'category',
                                        data: []
                                },
                                yAxis: {
                                        type: 'value'
                                },
                                series: [{
                                                name: '时间',
                                                type: 'line',
                                                data: []
                                        },
                                        {
                                                name: '成本',
                                                type: 'line',
                                                data: []
                                        },
                                        {
                                                name: '碳排放',
                                                type: 'line',
                                                data: []
                                        }
                                ]
                        };
                        chart.setOption(option);
                        return chart;
                }

                // 开始优化
                function startOptimization() {
                        // 获取参数
                        const modelParams = {
                                timeWindow: document.getElementById('timeWindow').value,
                                maxIterations: document.getElementById('maxIterations').value,
                                populationSize: document.getElementById('populationSize').value,
                                mutationRate: document.getElementById('mutationRate').value
                        };

                        const algorithmParams = {
                                algorithm: document.getElementById('algorithm').value,
                                goals: {
                                        time: document.getElementById('goal_time').checked,
                                        cost: document.getElementById('goal_cost').checked,
                                        emissions: document.getElementById('goal_emissions').checked
                                },
                                weights: {
                                        time: document.getElementById('weightTime').value,
                                        cost: document.getElementById('weightCost').value,
                                        emissions: document.getElementById('weightEmissions').value
                                }
                        };

                        // 重置进度和日志
                        document.getElementById('optimizationProgress').style.width = '0%';
                        document.getElementById('optimizationLog').innerHTML = '';

                        // 发送优化请求
                        fetch('/api/optimize', {
                                        method: 'POST',
                                        headers: {
                                                'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                                model_params: modelParams,
                                                algorithm_params: algorithmParams
                                        })
                                })
                                .then(response => response.json())
                                .then(data => {
                                        if (data.status === 'success') {
                                                // 更新优化结果
                                                document.getElementById('totalTime').textContent = data.results
                                                        .time;
                                                document.getElementById('totalCost').textContent = data.results
                                                        .cost;
                                                document.getElementById('totalEmissions').textContent = data
                                                        .results.emissions;

                                                // 更新图表
                                                const chart = echarts.getInstanceByDom(document.getElementById(
                                                        'optimizationChart'));
                                                chart.setOption({
                                                        xAxis: {
                                                                data: data.history.iterations
                                                        },
                                                        series: [{
                                                                        name: '时间',
                                                                        data: data
                                                                                .history
                                                                                .time
                                                                },
                                                                {
                                                                        name: '成本',
                                                                        data: data
                                                                                .history
                                                                                .cost
                                                                },
                                                                {
                                                                        name: '碳排放',
                                                                        data: data
                                                                                .history
                                                                                .emissions
                                                                }
                                                        ]
                                                });
                                        } else {
                                                alert('优化失败: ' + data.message);
                                        }
                                })
                                .catch(error => {
                                        alert('优化失败: ' + error);
                                });
                }

                // 添加日志
                function addLog(message) {
                        const logContainer = document.getElementById('optimizationLog');
                        const logEntry = document.createElement('div');
                        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                        logContainer.appendChild(logEntry);
                        logContainer.scrollTop = logContainer.scrollHeight;
                }

                // 更新进度
                function updateProgress(progress) {
                        document.getElementById('optimizationProgress').style.width = `${progress}%`;
                }

                // 页面加载完成后初始化
                document.addEventListener('DOMContentLoaded', () => {
                        initChart();
                });
        </script>
</body>

</html>