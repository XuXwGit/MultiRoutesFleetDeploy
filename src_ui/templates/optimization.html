<!DOCTYPE html>
<html lang="zh">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>调度优化 - 智慧航运物流优化系统</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <!-- ECharts 图表库 -->
        <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
        <!-- Plotly 图表库 -->
        <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
        <style>
                body {
                        background: #f6f8fa;
                }

                .card {
                        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.06);
                        border-radius: 14px;
                        border: none;
                }

                .card-header {
                        border-radius: 14px 14px 0 0 !important;
                }

                .form-label {
                        font-weight: 500;
                }

                .form-control,
                .form-select {
                        border-radius: 8px;
                }

                .input-group-text {
                        border-radius: 8px;
                }

                #startOptimizeBtn {
                        border-radius: 24px;
                        font-size: 1.1rem;
                        font-weight: 600;
                        box-shadow: 0 2px 8px 0 rgba(40, 167, 69, 0.08);
                }

                #optProgressBar {
                        border-radius: 12px;
                        margin-bottom: 1.5rem;
                }

                #optProgress {
                        border-radius: 12px;
                        font-size: 1rem;
                }

                #optLog {
                        background: #f8f9fa;
                        border-radius: 8px;
                        font-size: 0.98rem;
                }

                .param-card .card-body {
                        padding-bottom: 0.5rem;
                }

                .mb-2 {
                        margin-bottom: 1.1rem !important;
                }

                /* 结果卡片美化 */
                .result-card {
                        box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.04);
                        border-radius: 12px;
                        margin-bottom: 1.2rem;
                        transition: box-shadow 0.2s;
                }

                .result-card:hover {
                        box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.10);
                }

                .result-card h4 {
                        font-size: 2.1rem;
                        font-weight: bold;
                        color: #007bff;
                        margin-bottom: 0;
                }

                .result-card h6 {
                        font-size: 1.05rem;
                        color: #555;
                        margin-bottom: 0.5rem;
                }

                .opt-param-row {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 1.5rem;
                }

                .opt-param-col {
                        flex: 1 1 260px;
                        min-width: 220px;
                }

                @media (max-width: 991.98px) {
                        .opt-param-row {
                                flex-direction: column;
                                gap: 0.5rem;
                        }
                }

                /* 日志抽屉样式 */
                #logDrawerBtn {
                        position: fixed;
                        top: 40%;
                        right: 0;
                        z-index: 1050;
                        background: #17a2b8;
                        color: #fff;
                        border-radius: 8px 0 0 8px;
                        padding: 12px 18px;
                        font-weight: bold;
                        cursor: pointer;
                        box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.10);
                        transition: right 0.2s;
                }

                #logDrawer {
                        position: fixed;
                        top: 0;
                        right: -420px;
                        width: 400px;
                        height: 100vh;
                        background: #fff;
                        box-shadow: -2px 0 16px 0 rgba(0, 0, 0, 0.10);
                        z-index: 1100;
                        transition: right 0.3s;
                        display: flex;
                        flex-direction: column;
                }

                #logDrawer.open {
                        right: 0;
                }

                #logDrawerHeader {
                        padding: 18px 24px 12px 24px;
                        font-size: 1.2rem;
                        font-weight: bold;
                        background: #17a2b8;
                        color: #fff;
                        border-radius: 0 0 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                }

                #logDrawerClose {
                        background: none;
                        border: none;
                        color: #fff;
                        font-size: 1.5rem;
                        cursor: pointer;
                }

                #optLog {
                        flex: 1 1 auto;
                        padding: 18px 24px;
                        overflow-y: auto;
                        font-size: 1rem;
                        background: #f8f9fa;
                        border-radius: 0 0 0 0;
                        min-height: 120px;
                        max-height: calc(100vh - 60px);
                }

                @media (max-width: 600px) {
                        #logDrawer {
                                width: 100vw;
                                right: -100vw;
                        }

                        #logDrawer.open {
                                right: 0;
                        }
                }
        </style>
</head>

<body>
        <!-- 导航栏 -->
        {% include 'navbar.html' with context %}

        <div class="container mt-4">
                <!-- 参数设置Tabs -->
                <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                                参数设置
                        </div>
                        <div class="card-body">
                                <ul class="nav nav-tabs" id="paramTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="model-tab" data-bs-toggle="tab"
                                                        data-bs-target="#model" type="button" role="tab"><i
                                                                class="bi bi-calendar me-1"></i>模型参数</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="cost-tab" data-bs-toggle="tab"
                                                        data-bs-target="#cost" type="button" role="tab"><i
                                                                class="bi bi-coin me-1"></i> 成本参数</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="algo-tab" data-bs-toggle="tab"
                                                        data-bs-target="#algo" type="button" role="tab"><i
                                                                class="bi bi-gear me-1"></i>算法参数</button>
                                        </li>
                                </ul>
                                <div class="tab-content p-4 border border-top-0" id="paramTabsContent">
                                        <!-- 模型参数 -->
                                        <div class="tab-pane fade show active" id="model" role="tabpanel">
                                                <form id="modelParamsForm">
                                                        <div class="row">
                                                                <div class="col-md-6 mb-3">
                                                                        <label for="time_window">时间窗口 (0-180)</label>
                                                                        <input type="range" class="form-range" min="0"
                                                                                max="180" id="time_window"
                                                                                name="time_window" value="60"
                                                                                title="选择时间窗口"
                                                                                oninput="document.getElementById('time_window_value').innerText=this.value;">
                                                                        <span id="time_window_value">60</span>
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                        <label for="turn_over_time">空箱周转时间</label>
                                                                        <input type="number" class="form-control"
                                                                                id="turn_over_time"
                                                                                name="turn_over_time" value="14"
                                                                                title="请输入空箱周转时间"
                                                                                placeholder="请输入空箱周转时间">
                                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                        <label for="robustness">鲁棒系数</label>
                                                                        <input type="number" class="form-control"
                                                                                id="robustness" name="robustness"
                                                                                value="1"
                                                                                title="请输入鲁棒系数"
                                                                                placeholder="请输入鲁棒系数">
                                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                        <label for="demand_fluctuation">需求波动程度</label>
                                                                        <input type="number" class="form-control"
                                                                                id="demand_fluctuation"
                                                                                name="demand_fluctuation" value="0.1"
                                                                                step="0.01"
                                                                                title="请输入需求波动程度"
                                                                                placeholder="请输入需求波动程度">
                                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                        <label>船队类型</label>
                                                                        <div>
                                                                                <input type="radio" name="fleetType"
                                                                                        id="fleetType_homo"
                                                                                        value="homogeneous" checked
                                                                                        title="同质"> <label
                                                                                        for="fleetType_homo"
                                                                                        class="form-check-label">同质</label>
                                                                                <input type="radio" name="fleetType"
                                                                                        id="fleetType_hetero"
                                                                                        value="heterogeneous"
                                                                                        title="异质"> <label
                                                                                        for="fleetType_hetero"
                                                                                        class="form-check-label">异质</label>
                                                                        </div>
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                        <label>空箱类型</label>
                                                                        <div>
                                                                                <input type="checkbox"
                                                                                        id="emptyTypeNormal"
                                                                                        name="emptyTypeNormal" checked
                                                                                        title="启用普通空箱"> <label
                                                                                        for="emptyTypeNormal"
                                                                                        class="form-check-label">普通空箱</label>
                                                                                <input type="checkbox"
                                                                                        id="emptyTypeFold"
                                                                                        name="emptyTypeFold"
                                                                                        title="启用折叠空箱"> <label
                                                                                        for="emptyTypeFold"
                                                                                        class="form-check-label">折叠空箱</label>
                                                                        </div>
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                        <label for="emptyStrategy">空箱调运策略</label>
                                                                        <select class="form-select" id="emptyStrategy"
                                                                                name="emptyStrategy" title="请选择空箱调运策略">
                                                                                <option value="redirect">空箱重定向</option>
                                                                                <option value="reactive">反应式调运</option>
                                                                                <option value="normal">普通调运</option>
                                                                        </select>
                                                                </div>
                                                        </div>
                                                </form>
                                        </div>
                                        <!-- 成本参数 -->
                                        <div class="tab-pane fade" id="cost" role="tabpanel">
                                                <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                                <label for="empty_rent_cost">空箱单位租赁成本</label>
                                                                <input type="number" class="form-control"
                                                                        id="empty_rent_cost" name="empty_rent_cost"
                                                                        value="10"
                                                                        title="请输入空箱单位租赁成本" placeholder="请输入空箱单位租赁成本">
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                                <label for="penalty_coeff">违约惩罚系数</label>
                                                                <input type="number" class="form-control"
                                                                        id="penalty_coeff" name="penalty_coeff"
                                                                        value="100" title="请输入违约惩罚系数"
                                                                        placeholder="请输入违约惩罚系数">
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                                <label for="port_load_cost">港口装载操作成本</label>
                                                                <input type="number" class="form-control"
                                                                        id="port_load_cost" name="port_load_cost"
                                                                        value="50"
                                                                        title="请输入港口装载操作成本" placeholder="请输入港口装载操作成本">
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                                <label for="port_unload_cost">港口卸载操作成本</label>
                                                                <input type="number" class="form-control"
                                                                        id="port_unload_cost" name="port_unload_cost"
                                                                        value="50"
                                                                        title="请输入港口卸载操作成本" placeholder="请输入港口卸载操作成本">
                                                                        </div>
                                                                        <div class="col-md-6 mb-3">
                                                                                <label
                                                                                        for="port_transship_cost">港口转运操作成本</label>
                                                                                <input type="number"
                                                                                        class="form-control"
                                                                                        id="port_transship_cost"
                                                                                        name="port_transship_cost"
                                                                                        value="50" title="请输入港口转运操作成本"
                                                                                        placeholder="请输入港口转运操作成本">
                                                                        </div>
                                                                        <div class="col-md-6 mb-3">
                                                                                <label
                                                                                        for="laden_stay_cost">重箱港口滞留成本</label>
                                                                                <input type="number"
                                                                                        class="form-control"
                                                                                        id="laden_stay_cost"
                                                                                        name="laden_stay_cost" value="2"
                                                                                        title="请输入重箱港口滞留成本"
                                                                                        placeholder="请输入重箱港口滞留成本">
                                                                        </div>
                                                                        <div class="col-md-6 mb-3">
                                                                                <label
                                                                                        for="laden_stay_free_time">重箱港口豁免时间</label>
                                                                                <input type="number"
                                                                                        class="form-control"
                                                                                        id="laden_stay_free_time"
                                                                                        name="laden_stay_free_time"
                                                                                        value="3" title="请输入重箱港口豁免时间"
                                                                                        placeholder="请输入重箱港口豁免时间">
                                                                        </div>
                                                                        <div class="col-md-6 mb-3">
                                                                                <label
                                                                                        for="empty_stay_cost">空箱港口滞留成本</label>
                                                                                <input type="number"
                                                                                        class="form-control"
                                                                                        id="empty_stay_cost"
                                                                                        name="empty_stay_cost" value="1"
                                                                                        title="请输入空箱港口滞留成本"
                                                                                        placeholder="请输入空箱港口滞留成本">
                                                                        </div>
                                                                        <div class="col-md-6 mb-3">
                                                                                <label
                                                                                        for="empty_stay_free_time">空箱港口豁免时间</label>
                                                                                <input type="number"
                                                                                        class="form-control"
                                                                                        id="empty_stay_free_time"
                                                                                        name="empty_stay_free_time"
                                                                                        value="3" title="请输入空箱港口豁免时间"
                                                                                        placeholder="请输入空箱港口豁免时间">
                                                                </div>
                                                </div>
                                        </div>
                                        <!-- 算法参数 -->
                                        <div class="tab-pane fade" id="algo" role="tabpanel">
                                                <form id="algoParamsForm">
                                                        <div class="row">
                                                                <div class="col-md-6 mb-3">
                                                                        <label for="mipSolver">MIP求解器</label>
                                                                        <select class="form-select" id="mipSolver"
                                                                                name="mipSolver" title="请选择MIP求解器">
                                                                                <option value="cplex">Cplex</option>
                                                                                <option value="gurobi">Gurobi</option>
                                                                                <option value="copt">COPT</option>
                                                                                <option value="scip">SCIP</option>
                                                                        </select>
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                        <label for="algorithm">求解算法</label>
                                                                        <select class="form-select" id="algorithm"
                                                                                name="algorithm" title="请选择求解算法">
                                                                                <option value="bd">Benders Decomposition
                                                                                </option>
                                                                                <option value="ccg">Constraints and
                                                                                        Column
                                                                                        Generation
                                                                                </option>
                                                                                <option value="bdpap">Benders
                                                                                        Decomposition with
                                                                                        PAP
                                                                                </option>
                                                                                <option value="ccgpap">Constraints and
                                                                                        Column
                                                                                        Generation with PAP
                                                                                </option>
                                                                                <option value="other">其他算法</option>
                                                                                </select>
                                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                        <label>路径剪枝策略</label>
                                                                        <div>
                                                                                <input type="checkbox" id="enablePrune"
                                                                                        name="enablePrune" checked
                                                                                        title="启用路径剪枝"> <label
                                                                                        for="enablePrune"
                                                                                        class="form-check-label">启用</label>
                                                                                <input type="number"
                                                                                        class="form-control d-inline-block w-auto"
                                                                                        id="pruneCoef" name="pruneCoef"
                                                                                        min="0" max="1" step="0.01"
                                                                                        value="0.6" style="width:80px;"
                                                                                        title="剪枝系数" placeholder="剪枝系数">
                                                                        </div>
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                        <label>多线程设置</label>
                                                                        <div>
                                                                                <input type="checkbox" id="enableThread"
                                                                                        name="enableThread" checked
                                                                                        title="启用多线程"> <label
                                                                                        for="enableThread"
                                                                                        class="form-check-label">启用</label>
                                                                                <input type="number"
                                                                                        class="form-control d-inline-block w-auto"
                                                                                        id="threadCount"
                                                                                        name="threadCount" min="1"
                                                                                        value="10" style="width:80px;"
                                                                                        title="线程数量" placeholder="线程数量">
                                                                        </div>
                                                                </div>
                                                                <div class="col-md-6 mb-3">
                                                                        <label>样本评估设置</label>
                                                                        <div>
                                                                                <input type="checkbox" id="enableSample"
                                                                                        name="enableSample" checked
                                                                                        title="启用样本评估"> <label
                                                                                        for="enableSample"
                                                                                        class="form-check-label">启用</label>
                                                                                <input type="number"
                                                                                        class="form-control d-inline-block w-auto"
                                                                                        id="sampleCount"
                                                                                        name="sampleCount" min="1"
                                                                                        value="10" style="width:80px;"
                                                                                        title="样本数量" placeholder="样本数量">
                                                                        </div>
                                                                </div>
                                                        </div>
                                                </form>
                                                </div>
                                                </div>
                                <!-- 开始优化按钮 -->
                                <div class="my-4">
                                        <button class="btn btn-success w-100 mb-3" id="startOptimizeBtn"
                                                onclick="startOptimize()">开始优化</button>
                                        <div class="progress w-100" style="height: 24px; display:none;"
                                                id="optProgressBar">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                        role="progressbar" style="width: 0%" id="optProgress">
                                                </div>
                                        </div>
                                        </div>
                        </div>
                </div>
                <!-- 结果展示Tabs -->
                <div class="card mb-4">
                        <div class="card-header bg-primary text-white">结果展示</div>
                        <div class="card-body">
                                <ul class="nav nav-tabs" id="resultTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="result-tab" data-bs-toggle="tab"
                                                        data-bs-target="#result" type="button" role="tab"
                                                        aria-controls="result" aria-selected="true">
                                                        <i class="bi bi-bar-chart-line me-1"></i>求解结果
                                                </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="deploy-tab" data-bs-toggle="tab"
                                                        data-bs-target="#deploy" type="button" role="tab"
                                                        aria-controls="deploy" aria-selected="false">
                                                        <i class="bi bi-cpu me-1"></i>调度方案
                                                </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="result-cost-tab" data-bs-toggle="tab"
                                                        data-bs-target="#result-cost" type="button" role="tab"
                                                        aria-controls="result-cost" aria-selected="false">
                                                        <i class="bi bi-cash-stack me-1"></i>成本构成
                                                </button>
                                        </li>
                                </ul>
                                <div class="tab-content p-4 border border-top-0" id="resultTabsContent">
                                        <!-- 求解结果 -->
                                        <div class="tab-pane fade show active" id="result" role="tabpanel"
                                                aria-labelledby="result-tab">
                                                <div class="row text-center">
                                                        <div class="col-md-4 col-6 mb-4">
                                                                <div class="card bg-light result-card">
                                                                        <div class="card-body">
                                                                                <h6>总求解时间</h6>
                                                                                <h4 id="result_time">-</h4>
                                                                        </div>
                                                                </div>
                                                        </div>
                                                        <div class="col-md-4 col-6 mb-4">
                                                                <div class="card bg-light result-card">
                                                                        <div class="card-body">
                                                                                <h6>目标值</h6>
                                                                                <h4 id="result_total_cost">-</h4>
                                                                        </div>
                                                                </div>
                                                        </div>
                                                        <div class="col-md-4 col-6 mb-4">
                                                                <div class="card bg-light result-card">
                                                                        <div class="card-body">
                                                                                <h6>Gap</h6>
                                                                                <h4 id="result_gap">-</h4>
                                                                        </div>
                                                                </div>
                                                        </div>
                                                </div>
                                        </div>
                                        <!-- 调度方案 -->
                                        <div class="tab-pane fade" id="deploy" role="tabpanel"
                                                aria-labelledby="deploy-tab">
                                                <div id="deployTableContainer"></div>
                                        </div>
                                        <!-- 成本构成 -->
                                        <div class="tab-pane fade" id="result-cost" role="tabpanel"
                                                aria-labelledby="result-cost-tab">
                                                <div class="row">
                                                        <div class="col-md-6">
                                                                <table
                                                                        class="table table-bordered table-sm align-middle text-center">
                                                                        <thead>
                                                                                <tr>
                                                                                        <th>成本项</th>
                                                                                        <th>金额</th>
                                                                                        </tr>
                                                                                        </thead>
                                                                        <tbody id="costTableBody"></tbody>
                                                                        </table>
                                                                        </div>
                                                                        <div class="col-md-6">
                                                                <div id="costPieChart" style="width:100%;height:300px;">
                                                                </div>
                                                        </div>
                                                </div>
                                        </div>
                                </div>
                                </div>
                                </div>
                                </div>

        <!-- 日志抽屉按钮和抽屉本体 -->
        <div id="logDrawerBtn" onclick="openLogDrawer()">日志</div>
        <div id="logDrawer">
                <div id="logDrawerHeader">
                        日志
                        <button id="logDrawerClose" onclick="closeLogDrawer()">&times;</button>
                </div>
                <div id="optLog"></div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
        <script>
let logEventSource = null;

                function startOptimize() {
                // 检查表单是否正确获取
                const modelForm = document.getElementById('modelParamsForm');
                console.log(modelForm);

                // 测试参数收集
                const modelData = Object.fromEntries(new FormData(modelForm).entries());
                console.log(modelData);
                const algoForm = document.getElementById('algoParamsForm');
                const algoData = Object.fromEntries(new FormData(algoForm).entries());
                const params = {...modelData, ...algoData};
                // 显示进度条
                document.getElementById('optProgressBar').style.display = '';
                document.getElementById('optProgress').style.width = '10%';
                // 清空并显示日志区域
                const logArea = document.getElementById('optLog');
                logArea.innerHTML = '<div class="log-entry">正在提交优化请求...</div>';
                openLogDrawer(); // 自动打开日志抽屉
                // 清空结果
                document.getElementById('result_time').innerText = '-';
                document.getElementById('result_total_cost').innerText = '-';
                document.getElementById('result_gap').innerText = '-';
                // 添加超时处理
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300* 60* 1000); // 30秒超时
                fetch('/api/optimize', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(params),
                signal: controller.signal
                })
                .then(res => {
                clearTimeout(timeoutId);
                if (!res.ok) {
                throw new Error(`服务器响应错误: ${res.status} ${res.statusText}`);
                }
                return res.json();
                })
                .then(data => {
                // 关闭实时日志连接
                if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
                }

                if(data.status === 'success') {
                document.getElementById('optProgress').style.width = '100%';
                // 处理日志显示 - 保留，以防实时日志中有遗漏
                const logLines = data.log.split('\n');

                logLines.forEach(line => {
                if(line.trim() && !logArea.textContent.includes(line)) { // 只显示非空行且不重复的日志
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = line;
                logArea.appendChild(logEntry);
                }
                });

                // 滚动到最新日志
                logArea.scrollTop = logArea.scrollHeight;

                // 展示结果
                document.getElementById('result_time').innerText = data.result_time || '-';
                document.getElementById('result_total_cost').innerText = data.total_cost || '-';
                let gap = data.gap;
                document.getElementById('result_gap').innerText = (gap !== undefined && gap !== null && !isNaN(gap)) ?
                Number(gap).toExponential(2) : '-';
                renderDeployTable(data.solution, data.route_info, data.ports_of_call_info, data.vessel_info);
                renderCostTableAndChart({
                '船舶部署成本': data.oc,
                '重箱运输成本': data.lc,
                '空箱运输成本': data.ec,
                '空箱租赁成本': data.rc,
                '违约惩罚成本': data.pc
                });
                } else {
                const errorEntry = document.createElement('div');
                errorEntry.className = 'log-entry error';
                errorEntry.textContent = '优化失败: ' + (data.message || '未知错误');
                logArea.appendChild(errorEntry);
                }
                })
                .catch(err => {
                clearTimeout(timeoutId);
                // 关闭实时日志连接
                if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
                }

                const errorEntry = document.createElement('div');
                errorEntry.className = 'log-entry error';

                // 根据不同错误类型显示不同的错误信息
                if (err.name === 'AbortError') {
                errorEntry.textContent = '请求超时: 服务器响应时间过长，请检查后端服务是否正常运行';
                } else if (err.message.includes('Failed to fetch')) {
                errorEntry.textContent = '连接错误: 无法连接到服务器，请确保后端服务正在运行';
                } else {
                errorEntry.textContent = '请求异常: ' + err.message;
                }

                logArea.appendChild(errorEntry);
                console.error('API请求错误:', err);
                })
                .finally(() => {
                document.getElementById('optProgress').style.width = '100%';
                });
                }

                function openLogDrawer() {
                document.getElementById('logDrawer').classList.add('open');
                }
                function closeLogDrawer() {
                document.getElementById('logDrawer').classList.remove('open');
                // 关闭日志流连接
                if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
                }
                }
                // 添加日志样式
                const style = document.createElement('style');
                style.textContent = `
                .log-entry {
                padding: 4px 8px;
                margin: 2px 0;
                border-radius: 4px;
                font-family: monospace;
                white-space: pre-wrap;
                word-break: break-all;
                }
                .log-entry.error {
                background-color: #ffebee;
                color: #c62828;
                }
                #optLog {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 12px;
                font-size: 0.9rem;
                line-height: 1.4;
                max-height: 500px;
                overflow-y: auto;
}
`;
document.head.appendChild(style);
function renderDeployTable(deployPlan, routeInfo, portsOfCallInfo, vesselInfo) {
let html = '<table class="table table-bordered table-sm align-middle text-center">';
        html += `
        <thead>
                <tr>
                        <th>航线</th>
                        <th>航线港口</th>
                        <th>分配船舶</th>
                </tr>
        </thead>
        <tbody>`;
                for (const [routeId, vesselId] of Object.entries(deployPlan || {})) {
                html += `<tr>
                        <td>${routeInfo?.[routeId] ?? routeId}</td>
                        <td>${portsOfCallInfo?.[routeId] ?? routeId}</td>
                        <td>${vesselInfo?.[vesselId] ?? vesselId}</td>
                </tr>`;
                }
                html += `</tbody>
</table>`;
document.getElementById('deployTableContainer').innerHTML = html;
}

function renderCostTableAndChart(costs) {
let tableHtml = '';
const pieData = [];
for (const [name, value] of Object.entries(costs || {})) {
tableHtml += `<tr>
        <td>${name}</td>
        <td>${value}</td>
</tr>`;
pieData.push({name, value: parseFloat(value)});
}
document.getElementById('costTableBody').innerHTML = tableHtml;

const chart = echarts.init(document.getElementById('costPieChart'));
chart.setOption({
title: {text: '成本占比', left: 'center', top: 10, textStyle: {fontSize: 16}},
tooltip: {trigger: 'item'},
legend: {bottom: 0},
series: [{
type: 'pie',
radius: '60%',
data: pieData,
label: {formatter: '{b}: {d}%'}
}]
});
}

function formatNumber(num) {
if (num === undefined || num === null || isNaN(num)) return '-';
if (Math.abs(num) >= 1e6 || Math.abs(num) < 1e-2) { return Number(num).toExponential(2); } return
        Number(num).toLocaleString(); }
// 参数设置项显示/隐藏逻辑
function toggleDiv(checkboxId, divId) {
document.getElementById(checkboxId).addEventListener('change', function() {
document.getElementById(divId).style.display = this.checked ? '' : 'none';
});
}
toggleDiv('enableThread', 'threadCountDiv');
toggleDiv('enableSample', 'sampleCountDiv');
toggleDiv('enablePrune', 'pruneCoefDiv');
// 表单提交时收集新增参数（请在原有提交逻辑中补充如下字段）
// fleetType, emptyTypes, emptyStrategy, mipSolver, enableThread, threadCount, enableSample, sampleCount, enablePrune,
pruneCoef

document.getElementById('startOptimization').addEventListener('click', startOptimize);
document.addEventListener('DOMContentLoaded', function () {
var resultTabs = document.getElementById('resultTabs');
if (resultTabs) {
resultTabs.addEventListener('shown.bs.tab', function (event) {
if (event.target.getAttribute('data-bs-target') === '#cost') {
// 只有切换到成本构成Tab时才resize
if (window.echarts) {
var chartDom = document.getElementById('costPieChart');
if (chartDom) {
var chart = echarts.getInstanceByDom(chartDom);
if (chart) chart.resize();
}
}
}
});
}
});
        </script>
</body>

</html>