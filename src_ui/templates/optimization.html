<!DOCTYPE html>
<html lang="zh">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>调度优化 - 船舶调度系统</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
        <style>
                body {
                        background: #f6f8fa;
                }

                .card {
                        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.06);
                        border-radius: 14px;
                        border: none;
                }

                .card-header {
                        border-radius: 14px 14px 0 0 !important;
                }

                .form-label {
                        font-weight: 500;
                }

                .form-control,
                .form-select {
                        border-radius: 8px;
                }

                .input-group-text {
                        border-radius: 8px;
                }

                #startOptimizeBtn {
                        border-radius: 24px;
                        font-size: 1.1rem;
                        font-weight: 600;
                        box-shadow: 0 2px 8px 0 rgba(40, 167, 69, 0.08);
                }

                #optProgressBar {
                        border-radius: 12px;
                        margin-bottom: 1.5rem;
                }

                #optProgress {
                        border-radius: 12px;
                        font-size: 1rem;
                }

                #optLog {
                        background: #f8f9fa;
                        border-radius: 8px;
                        font-size: 0.98rem;
                }

                .param-card .card-body {
                        padding-bottom: 0.5rem;
                }

                .mb-2 {
                        margin-bottom: 1.1rem !important;
                }

                /* 结果卡片美化 */
                .result-card {
                        box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.04);
                        border-radius: 12px;
                        margin-bottom: 1.2rem;
                        transition: box-shadow 0.2s;
                }

                .result-card:hover {
                        box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.10);
                }

                .result-card h4 {
                        font-size: 2.1rem;
                        font-weight: bold;
                        color: #007bff;
                        margin-bottom: 0;
                }

                .result-card h6 {
                        font-size: 1.05rem;
                        color: #555;
                        margin-bottom: 0.5rem;
                }

                .opt-param-row {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 1.5rem;
                }

                .opt-param-col {
                        flex: 1 1 260px;
                        min-width: 220px;
                }

                @media (max-width: 991.98px) {
                        .opt-param-row {
                                flex-direction: column;
                                gap: 0.5rem;
                        }
                }

                /* 日志抽屉样式 */
                #logDrawerBtn {
                        position: fixed;
                        top: 40%;
                        right: 0;
                        z-index: 1050;
                        background: #17a2b8;
                        color: #fff;
                        border-radius: 8px 0 0 8px;
                        padding: 12px 18px;
                        font-weight: bold;
                        cursor: pointer;
                        box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.10);
                        transition: right 0.2s;
                }

                #logDrawer {
                        position: fixed;
                        top: 0;
                        right: -420px;
                        width: 400px;
                        height: 100vh;
                        background: #fff;
                        box-shadow: -2px 0 16px 0 rgba(0, 0, 0, 0.10);
                        z-index: 1100;
                        transition: right 0.3s;
                        display: flex;
                        flex-direction: column;
                }

                #logDrawer.open {
                        right: 0;
                }

                #logDrawerHeader {
                        padding: 18px 24px 12px 24px;
                        font-size: 1.2rem;
                        font-weight: bold;
                        background: #17a2b8;
                        color: #fff;
                        border-radius: 0 0 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                }

                #logDrawerClose {
                        background: none;
                        border: none;
                        color: #fff;
                        font-size: 1.5rem;
                        cursor: pointer;
                }

                #optLog {
                        flex: 1 1 auto;
                        padding: 18px 24px;
                        overflow-y: auto;
                        font-size: 1rem;
                        background: #f8f9fa;
                        border-radius: 0 0 0 0;
                        min-height: 120px;
                        max-height: calc(100vh - 60px);
                }

                @media (max-width: 600px) {
                        #logDrawer {
                                width: 100vw;
                                right: -100vw;
                        }

                        #logDrawer.open {
                                right: 0;
                        }
                }
        </style>
</head>

<body>
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
                <div class="container-fluid">
                        <a class="navbar-brand" href="/">船舶调度系统</a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                data-bs-target="#navbarNav" aria-label="切换导航">
                                <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarNav">
                                <ul class="navbar-nav">
                                        <li class="nav-item">
                                                <a class="nav-link" href="/overview">概览</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link" href="/data">数据管理</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link active" href="/optimization">调度优化</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link" href="/analysis">数据分析</a>
                                        </li>
                                </ul>
                        </div>
                </div>
        </nav>

        <div class="container mt-4">
                <!-- 顶部参数输入区 -->
                <div class="card mb-4 param-card">
                        <div class="card-header bg-primary text-white">参数设置</div>
                        <div class="card-body">
                                <div class="opt-param-row">
                                        <div class="opt-param-col">
                                                <form id="modelParamsForm">
                                                        <div class="mb-2">
                                                                <label class="form-label">时间窗口 (0-180)</label>
                                                                <input type="number" class="form-control"
                                                                        name="time_window" min="0" max="180" value="60"
                                                                        placeholder="请输入时间窗口" title="请输入时间窗口">
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">空箱周转时间</label>
                                                                <input type="number" class="form-control"
                                                                        name="turn_over_time" min="0" max="180"
                                                                        value="14" placeholder="请输入空箱周转时间"
                                                                        title="请输入空箱周转时间">
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">鲁棒系数</label>
                                                                <input type="number" class="form-control"
                                                                        name="robustness" step="100" value="1"
                                                                        placeholder="请输入鲁棒系数" title="请输入鲁棒系数">
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">需求波动程度</label>
                                                                <input type="number" class="form-control"
                                                                        name="demand_fluctuation" step="0.01"
                                                                        value="0.1" placeholder="请输入需求波动程度"
                                                                        title="请输入需求波动程度">
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">空箱单位租赁成本</label>
                                                                <input type="number" class="form-control"
                                                                        name="empty_rent_cost" step="1" value="10"
                                                                        placeholder="请输入空箱单位租赁成本" title="请输入空箱单位租赁成本">
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">违约惩罚系数</label>
                                                                <input type="number" class="form-control"
                                                                        name="penalty_coeff" step="1.0" value="100"
                                                                        placeholder="请输入违约惩罚系数" title="请输入违约惩罚系数">
                                                        </div>
                                                </form>
                                        </div>
                                        <div class="opt-param-col">
                                                <form>
                                                        <div class="mb-2">
                                                                <label class="form-label">港口装载操作成本</label>
                                                                <input type="number" class="form-control"
                                                                        name="port_load_cost" step="1" value="50"
                                                                        placeholder="请输入港口装载操作成本" title="请输入港口装载操作成本">
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">港口卸载操作成本</label>
                                                                <input type="number" class="form-control"
                                                                        name="port_unload_cost" step="5" value="50"
                                                                        placeholder="请输入港口卸载操作成本" title="请输入港口卸载操作成本">
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">港口转运操作成本</label>
                                                                <input type="number" class="form-control"
                                                                        name="port_transship_cost" step="5" value="50"
                                                                        placeholder="请输入港口转运操作成本" title="请输入港口转运操作成本">
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">重箱港口滞留成本</label>
                                                                <div class="input-group">
                                                                        <input type="number" class="form-control"
                                                                                name="laden_stay_cost" step="0.01"
                                                                                value="2" placeholder="请输入重箱港口滞留成本"
                                                                                title="请输入重箱港口滞留成本">
                                                                        <span class="input-group-text">成本值</span>
                                                                        <input type="number" class="form-control"
                                                                                name="laden_stay_free_time" step="1"
                                                                                value="3" placeholder="请输入重箱滞留豁免时间"
                                                                                title="请输入重箱滞留豁免时间">
                                                                        <span class="input-group-text">豁免时间</span>
                                                                </div>
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">空箱港口滞留成本</label>
                                                                <div class="input-group">
                                                                        <input type="number" class="form-control"
                                                                                name="empty_stay_cost" step="0.01"
                                                                                value="1" placeholder="请输入空箱港口滞留成本"
                                                                                title="请输入空箱港口滞留成本">
                                                                        <span class="input-group-text">成本值</span>
                                                                        <input type="number" class="form-control"
                                                                                name="empty_stay_free_time" step="1"
                                                                                value="3" placeholder="请输入空箱滞留豁免时间"
                                                                                title="请输入空箱滞留豁免时间">
                                                                        <span class="input-group-text">豁免时间</span>
                                                                </div>
                                                        </div>
                                                        </form>
                                                        </div>
                                                        <div class="opt-param-col">
                                                                <form id="algoParamsForm">
                                                                        <div class="mb-2">
                                                                                <label class="form-label">求解算法</label>
                                                                                <select class="form-select"
                                                                                        name="algorithm"
                                                                                        title="请选择求解算法">
                                                                                        <option value="bd">Benders
                                                                                                Decomposition
                                                                                        </option>
                                                                                        <option value="ccg">C&CG
                                                                                        </option>
                                                                                        <option value="bdpap">BD&PAP
                                                                                        </option>
                                                                                        <option value="ccgpap">CCG&PAP
                                                                                        </option>
                                                                                        <option value="cplex">Cplex
                                                                                                Solver</option>
                                                                                        </select>
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">最大迭代次数 (0-1000)</label>
                                                                <input type="number" class="form-control"
                                                                        name="max_iter" min="0" max="1000" value="100"
                                                                        placeholder="请输入最大迭代次数" title="请输入最大迭代次数">
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">最大求解时间 (0-3600s)</label>
                                                                <input type="number" class="form-control"
                                                                        name="max_time" min="0" max="3600" value="600"
                                                                        placeholder="请输入最大求解时间" title="请输入最大求解时间">
                                                        </div>
                                                        <div class="mb-2">
                                                                <label class="form-label">MIP Gap</label>
                                                                <input type="number" class="form-control" name="mip_gap"
                                                                        step="0.0001" value="0.01" placeholder="请输入MIP
                                                                        Gap" title="请输入MIP Gap">
                                                        </div>
                                                        </form>
                                                        </div>
                                                        </div>
                                <div class="row mt-3">
                                        <div class="col-md-4 col-12 mb-2">
                                                <button class="btn btn-success w-100" id="startOptimizeBtn"
                                                        onclick="startOptimize()">开始优化</button>
                                        </div>
                                        <div class="col-md-4 col-12 mb-2">
                                                <div class="progress" style="height: 24px; display:none;"
                                                        id="optProgressBar">
                                                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                                role="progressbar" style="width: 0%" id="optProgress">
                                                        </div>
                                                </div>
                                                </div>
                                                </div>
                        </div>
                        </div>
                        <!-- 底部结果展示区 -->
                        <div class="card">
                                <div class="card-header bg-info text-white">优化结果</div>
                                <div class="card-body" id="optResult">
                                        <div class="row text-center">
                                                <div class="col-md-4 col-6 mb-4">
                                                        <div class="card bg-light result-card">
                                                        <div class="card-body">
                                                                <h6>总求解时间</h6>
                                                                <h4 id="result_time">-</h4>
                                                                </div>
                                                </div>
                                                </div>
                                                <div class="col-md-4 col-6 mb-4">
                                                        <div class="card bg-light result-card">
                                                                <div class="card-body">
                                                                        <h6>总成本</h6>
                                                                        <h4 id="result_total_cost">-</h4>
                                                                </div>
                                                                </div>
                                                                </div>
                                                                <div class="col-md-4 col-6 mb-4">
                                                                        <div class="card bg-light result-card">
                                                                                <div class="card-body">
                                                                <h6>船舶固定部署成本(OC)</h6>
                                                                <h4 id="result_oc">-</h4>
                                                                </div>
                                                                </div>
                                                                </div>
                                                                <div class="col-md-4 col-6 mb-4">
                                                                        <div class="card bg-light result-card">
                                                                                <div class="card-body">
                                                                <h6>集装箱运输成本(LC+EC)</h6>
                                                                <h4 id="result_lcec">-</h4>
                                                                </div>
                                                                </div>
                                                                </div>
                                        <div class="col-md-4 col-6 mb-4">
                                                <div class="card bg-light result-card">
                                                        <div class="card-body">
                                                                <h6>空集装箱租赁成本(RC)</h6>
                                                                <h4 id="result_rc">-</h4>
                                                                </div>
                                                                </div>
                                        </div>
                                        <div class="col-md-4 col-6 mb-4">
                                                <div class="card bg-light result-card">
                                                        <div class="card-body">
                                                                <h6>违约惩罚成本(PC)</h6>
                                                                <h4 id="result_pc">-</h4>
                                                                </div>
                                                                </div>
                                                                </div>
                                                                </div>
                        </div>
                        </div>
                        </div>
<!-- 日志抽屉按钮和抽屉本体 -->
<div id="logDrawerBtn" onclick="openLogDrawer()">日志</div>
<div id="logDrawer">
        <div id="logDrawerHeader">
                日志
                <button id="logDrawerClose" onclick="closeLogDrawer()">&times;</button>
            </div>
            <div id="optLog"></div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
        <script>
let logEventSource = null;

                function startOptimize() {
                // 检查表单是否正确获取
                const modelForm = document.getElementById('modelParamsForm');
                console.log(modelForm);

                // 测试参数收集
                const modelData = Object.fromEntries(new FormData(modelForm).entries());
                console.log(modelData);
                const algoForm = document.getElementById('algoParamsForm');
                const algoData = Object.fromEntries(new FormData(algoForm).entries());
                const params = {...modelData, ...algoData};
                // 显示进度条
                document.getElementById('optProgressBar').style.display = '';
                document.getElementById('optProgress').style.width = '10%';
                // 清空并显示日志区域
                const logArea = document.getElementById('optLog');
                logArea.innerHTML = '<div class="log-entry">正在提交优化请求...</div>';
                openLogDrawer(); // 自动打开日志抽屉
                // 清空结果
                document.getElementById('result_time').innerText = '-';
                document.getElementById('result_total_cost').innerText = '-';
                document.getElementById('result_oc').innerText = '-';
                document.getElementById('result_lcec').innerText = '-';
                document.getElementById('result_rc').innerText = '-';
                document.getElementById('result_pc').innerText = '-';
                // 添加超时处理
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300* 60* 1000); // 30秒超时
                fetch('/api/optimize', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(params),
                signal: controller.signal
                })
                .then(res => {
                clearTimeout(timeoutId);
                if (!res.ok) {
                throw new Error(`服务器响应错误: ${res.status} ${res.statusText}`);
                }
                return res.json();
                })
                .then(data => {
                // 关闭实时日志连接
                if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
                }

                if(data.status === 'success') {
                document.getElementById('optProgress').style.width = '100%';
                // 处理日志显示 - 保留，以防实时日志中有遗漏
                const logLines = data.log.split('\n');

                logLines.forEach(line => {
                if(line.trim() && !logArea.textContent.includes(line)) { // 只显示非空行且不重复的日志
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.textContent = line;
                logArea.appendChild(logEntry);
                }
                });

                // 滚动到最新日志
                logArea.scrollTop = logArea.scrollHeight;

                // 展示结果
                document.getElementById('result_time').innerText = data.result_time || '-';
                document.getElementById('result_total_cost').innerText = data.total_cost || '-';
                document.getElementById('result_oc').innerText = data.oc || '-';
                document.getElementById('result_lcec').innerText = data.lcec || '-';
                document.getElementById('result_rc').innerText = data.rc || '-';
                document.getElementById('result_pc').innerText = data.pc || '-';
                } else {
                const errorEntry = document.createElement('div');
                errorEntry.className = 'log-entry error';
                errorEntry.textContent = '优化失败: ' + (data.message || '未知错误');
                logArea.appendChild(errorEntry);
                }
                })
                .catch(err => {
                clearTimeout(timeoutId);
                // 关闭实时日志连接
                if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
                }

                const errorEntry = document.createElement('div');
                errorEntry.className = 'log-entry error';

                // 根据不同错误类型显示不同的错误信息
                if (err.name === 'AbortError') {
                errorEntry.textContent = '请求超时: 服务器响应时间过长，请检查后端服务是否正常运行';
                } else if (err.message.includes('Failed to fetch')) {
                errorEntry.textContent = '连接错误: 无法连接到服务器，请确保后端服务正在运行';
                } else {
                errorEntry.textContent = '请求异常: ' + err.message;
                }

                logArea.appendChild(errorEntry);
                console.error('API请求错误:', err);
                })
                .finally(() => {
                document.getElementById('optProgress').style.width = '100%';
                });
                }

                function openLogDrawer() {
                document.getElementById('logDrawer').classList.add('open');
                }
                function closeLogDrawer() {
                document.getElementById('logDrawer').classList.remove('open');
                // 关闭日志流连接
                if (logEventSource) {
                logEventSource.close();
                logEventSource = null;
                }
                }
                // 添加日志样式
                const style = document.createElement('style');
                style.textContent = `
                .log-entry {
                padding: 4px 8px;
                margin: 2px 0;
                border-radius: 4px;
                font-family: monospace;
                white-space: pre-wrap;
                word-break: break-all;
                }
                .log-entry.error {
                background-color: #ffebee;
                color: #c62828;
                }
                #optLog {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 12px;
                font-size: 0.9rem;
                line-height: 1.4;
                max-height: 500px;
                overflow-y: auto;
}
`;
document.head.appendChild(style);
        </script>
</body>

</html>